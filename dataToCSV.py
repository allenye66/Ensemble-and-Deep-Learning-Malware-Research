
import csv
import os

'''
def countOpcodes(filename):
	with open(filename) as f:
			s = set()
			for word in f:
				s.add(word.rstrip())
	#s = getUniqueOpcodes(filename)
		#print(s)
		#print(len(s))

	d = {}
	for word in s:
		d[word] = 0
	with open(filename) as f:
		for word in f:
			word = word.rstrip()
			d[word] += 1

	d=sorted(d.items(), key=lambda x: x[1], reverse = True)
	#print(d)
	#print(type(d))

	arr = []
	for key, value in d:
	    arr.append(key)


	return arr,d
		#print(d)


#problem, each file has diff opcodes
#traverse through each text file adding the opcodes to a set and make that set part of the header
#if an opcode in the header is not in the dict list, set the dict list to 0
'''

def getData(filename):

	opcode_features = []

	opcodes = ['mov', 'push', 'call', 'lea', 'add', 'jae', 'inc', 'cmp', 'sub', 'jmp', 'dec', 'shl', 'pop', 'xchg', 'je', 'jne', 'xor', 'test', 'ret', 'jo', 'imul', 'and', 'in', 'jge', 'outsb', 'fstp', 'sbb', 'adc', 'jp', 'insb', 'other']
	

	#for converting the opcodes into numbers
	encode_dict = {}


	c = 1
	for i in opcodes:
		if i != "other":
			encode_dict[i] = c
			c+=1
	#other = 0 and "null" = -1
	encode_dict.update({'other' : 0} )



	#for counting how much of each opcode
	d = {}
	for o in opcodes:
		d[o] = 0

	f =open(filename,'r')
	i = 0

	for line in f:
		if i < 1000:
			opcode_features.append(encode_dict[line[:-1]])
		d[line[:-1]] += 1
		i += 1
	#print(d)


	#if the array is too small
	if len(opcode_features) != 1000:
		for i in range(1000-len(opcode_features)):
			opcode_features.append(-1)

	mov = d['mov']
	push = d['push']
	call = d['call']
	lea = d['lea']
	add = d['add']
	jae = d['jae']
	inc = d['inc']
	cmp_ = d['cmp']
	sub = d['sub']
	jmp = d['jmp']
	dec = d['dec']
	shl = d['shl']
	pop = d['pop']
	xchg = d['xchg']
	je = d['je']
	jne = d['jne']
	xor = d['xor']
	test = d['test']
	ret = d['ret']
	jo = d['jo']
	imul = d['imul']
	and_ = d['and']
	in_ = d['in']
	jge = d['jge']
	outsb = d['outsb']
	fstp = d['fstp']
	sbb = d['sbb']
	adc = d['adc']
	jp = d['jp']
	insb = d['insb']
	other = d['other']

	arr = [i, mov, push, call, lea, add, jae, inc, cmp_, sub, jmp, dec, shl, pop, xchg, je, jne, xor, test, ret, jo, imul, and_, in_, jge, outsb, fstp, sbb, adc, jp, insb, other]
	arr = arr + opcode_features
	return arr


def retrieve_opcodes(filename, total_opcodes):
	arr = []
	f =open(filename,'r')
	for line in f:
		arr.append(line[:-1])


if __name__ == '__main__':

	header = ['Family', 'Total Opcodes', 'mov', 'push', 'call', 'lea', 'add', 'jae', 'inc', 'cmp', 'sub', 'jmp', 'dec', 'shl', 'pop', 'xchg', 'je', 'jne', 'xor', 'test', 'ret', 'jo', 'imul', 'and', 'in', 'jge', 'outsb', 'fstp', 'sbb', 'adc', 'jp', 'insb', 'other']

	


	n_features = 1000
	for i in range(n_features):
		header.append("Opcode: " + str(i))
	with open('zbot.csv', 'w') as g:

	        writer = csv.writer(g)
	        writer.writerow(header)
	        for filename in os.listdir('/Users/allen/Desktop/ExtractedOpcodes2/zbot_opcodes'):
	        	if filename != ".DS_Store":
		        	filename = "/Users/allen/Desktop/ExtractedOpcodes2/zbot_opcodes/" + filename
		        	row =  getData(filename)
		        	row.insert(0, 'ZBOT')


		        	#print(filename, ":", totalOpcodes(filename))
		        	#print(row)
		        	writer.writerow(row)


	        #for every file inside zbot folder:
	        	#count the opcodes and add a new row